
/**
var jq = document.createElement('script');
jq.src = "https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js";
document.getElementsByTagName('head')[0].appendChild(jq);
**/
var symbols = [["EDELWEISS",3870465,237.0,'Bull'],["IDBI",377857,74.95,'Bull'],["INDIANB",3663105,301.0,'Bull'],["JMFINANCIL",3491073,130.1,'Bull'],["PNB",2730497,97.95,'Bull'],["RCF",null,74.1,'Bull'],["UNIONBANK",2752769,92.5,'Bull']];




//debugger;
var csrfToken = "XGvCpW4IvsjqIxqkRjzAObF7cA92a7GB";
var upper="upper", lower="lower";
var typeOfOrder="LIMIT";
var now = new Date();
var entryPercFromOpen="0.2";

var entryTradeObjects = [], exitTradeObjects = [];
var diffPerc = 1, target=0.2, divisable = 3, qty="1", invest=6500;var status="";
var varietyType = "regular";
function clearOrder(){
	order.Id="";order.TransactionType= "";order.OrderType="";order.Quantity="";	order.LimitPrice="";order.TriggerPrice="";order.OpenPrice="";
}
function generateOrderObject(company, price, transaction_type, order_type, variety, open)
{
	var order = {
		Id:"",
		TransactionType:"",
		OrderType:"",
		Quantity:"",
		LimitPrice:"",
		TriggerPrice:"",
		Variety:""
	};
	//clearOrder();
	order.Id=company;
	order.TransactionType= transaction_type;
	order.OrderType=order_type;
	order.Quantity=qty;
	order.LimitPrice=price;
	order.OpenPrice=open;
	order.TriggerPrice = 0;
	order.Variety=variety;
	return order;
}
function getDate(dayToSubstract) {
    var date = new Date();
    date.setDate(date.getDate()-dayToSubstract);
    return date.getFullYear() + '-' + ('0' + (date.getMonth()+1)).slice(-2) + '-' + ('0' + date.getDate()).slice(-2);
}

function getOpenHighLow(data)
{
	var high=0,low=0,open=0;
	if(data.data.candles.length!=0){
		high = data.data.candles[data.data.candles.length-1][2];
		low = data.data.candles[data.data.candles.length-1][3];
		open = data.data.candles[data.data.candles.length-1][1];
	}
	return high+"_"+low+"_"+open;
}
function sleep(milliseconds) {
  var start = new Date().getTime();
  for (var i = 0; i < 1e7; i++) {
    if ((new Date().getTime() - start) > milliseconds){
      break;
    }
  }
}
var orderIds=[];
function start(){
	populateTradeObjects();
	var amntToInvestPerSymbol = invest/entryTradeObjects.length;
	console.log(entryTradeObjects);
	for (var i=0; i<entryTradeObjects.length; i++)
	{
		orderId = PlaceOrder(entryTradeObjects[i], amntToInvestPerSymbol, "regular");
		if(orderId!=""){
			orderIds[orderIds.length]=executedOrders(orderId, entryTradeObjects[i].Id);
		}else {
			exitTradeObjects.splice(i,1);
		}
	}
}

function PlaceOrder(Order, amntToInvestPerSymbol, variety)
{ 
	var order_id="";
    $.ajaxSettings.beforeSend=function(xhr){
        xhr.setRequestHeader('Accept', "application/json, text/plain, */*");
        xhr.setRequestHeader('Content-Type', "application/x-www-form-urlencoded");
		xhr.setRequestHeader('x-csrftoken', csrfToken);
		xhr.setRequestHeader('x-kite-version', '1.2.0');
    };
	noOfShares = amntToInvestPerSymbol/Order.OpenPrice;
	Order.Quantity = parseInt(noOfShares);
	var OrderData = "exchange=NSE&tradingsymbol="+Order.Id+"&transaction_type="+Order.TransactionType+"&order_type="+Order.OrderType+"&quantity="+Order.Quantity+"&price="+Order.LimitPrice+"&product=MIS&validity=DAY&disclosed_quantity=0&trigger_price="+Order.TriggerPrice+"&squareoff=0&stoploss=0&trailing_stoploss=0&variety="+variety+"";
	
	

	$.ajax({
	statusCode: {
	 500: function() {
	console.error("Error while placing order.");
	  }
	},
	url : "https://kite.zerodha.com/api/orders/"+varietyType,
	type: "POST",
	async: false,
	data : OrderData,
	success: function(data, textStatus, jqXHR)
	{
		if(data != null && data.status == "success")
			order_id =  data.data.order_id;
	},
	error: function (jqXHR, textStatus, errorThrown)
	{
		console.log("error");
	}
	});
	if(order_id=="") sleep(2000);
	return order_id;
}

function getTickPrice(price){
	var tickPrice='';
	toAdd = 10-(((parseFloat(price).toFixed(2))*100)%10);
	if(parseInt(toAdd) < 5){
		tickPrice = (((parseFloat(price).toFixed(2))*100)+toAdd)/100;
	}
	if(parseInt(toAdd) >= 5){
		tickPrice = (((parseFloat(price).toFixed(2))*100)+(toAdd-5))/100;
	}
	return tickPrice;
}
function executedOrders(orderId, symbol){
	var executedOrders = {
		OrderId:"",
		Symbol:"",
		Status: ""
	};
	executedOrders.OrderId=orderId;
	executedOrders.Symbol=symbol;
	executedOrders.Status="";
	return executedOrders;
}
function isEligibleForTrade(symbol, preopenPrice, gapDir, entryPrice){
	var isEligible=true;
	for(var i=0; i< symbols.length; i++){
		if(symbols[i][0]==symbol)
		{
			openPrice = getOpenPrice(symbols[i][1]);
			if(gapDir==upper && parseFloat(openPrice) < parseFloat(entryPrice)){
				isEligible = false;
				break;
			}else if(gapDir==lower && parseFloat(openPrice) > parseFloat(entryPrice)){
				isEligible = false;
				break;
			}
		}
	}
	return isEligible;
}
function populateTradeObjects(){
	for(var i=0; i< symbols.length; i++){
		name = symbols[i][0];
		dir = symbols[i][3];
		open = parseFloat(symbols[i][2]);
		if(dir=='Bull'){
			entryPrice = open + (open*entryPercFromOpen)/100;
			entryPrice = getTickPrice(entryPrice);
			entryTradeObjects[entryTradeObjects.length] = generateOrderObject(name, entryPrice, "BUY", typeOfOrder, varietyType,open);
		}else if (dir=='Bear'){
			entryPrice = open - (open*entryPercFromOpen)/100;
			entryPrice = getTickPrice(entryPrice);
			entryTradeObjects[entryTradeObjects.length] = generateOrderObject(name, entryPrice, "SELL", typeOfOrder, varietyType,open);
		}
	}
}

function getOpenPrice(token)
{ 
    $.ajaxSettings.beforeSend=function(xhr){
        xhr.setRequestHeader('Accept', "application/json, text/plain, */*");
        xhr.setRequestHeader('Content-Type', "application/json;charset=utf-8");
		xhr.setRequestHeader('x-csrftoken', csrfToken);
    };
	var result="", publicToken="c06281aea28be10bc89284ff746badb7", accessToken="vTVZBKDrgZGJn99YOukJ9tGg5UE7L9we";
	var from=getDate(0), to =getDate(0);
	var getUrl = "https://kite.zerodha.com/api/chart/"+token+"/day?public_token="+publicToken+"&user_id=DP3137&api_key=kitefront&access_token="+accessToken+"&from="+from+"&to="+to+"&1486220894071";
	console.log(getUrl);

	$.ajax({
		statusCode: {
			500: function() {
				console.error("Error while placing order.");
			}
		},
		url : getUrl,
		type: "GET",
		async: false,
		success: function(data, textStatus, jqXHR)
		{		
			if(data != null && data.status == "success"){
				result = getOpenHighLow(data);
			}
		},
		error: function (jqXHR, textStatus, errorThrown)
		{
			console.log("error");
		}
	});
	return result.split("_")[2];
}

function getRange(token)
{ 
    $.ajaxSettings.beforeSend=function(xhr){
        xhr.setRequestHeader('Accept', "application/json, text/plain, */*");
        xhr.setRequestHeader('Content-Type', "application/json;charset=utf-8");
		xhr.setRequestHeader('x-csrftoken', csrfToken);
    };
	var result="", publicToken="c06281aea28be10bc89284ff746badb7", accessToken="vTVZBKDrgZGJn99YOukJ9tGg5UE7L9we";
	var from=getDate(4), to =getDate(3);
	var getUrl = "https://kite.zerodha.com/api/chart/"+token+"/day?public_token="+publicToken+"&user_id=DP3137&api_key=kitefront&access_token="+accessToken+"&from="+from+"&to="+to+"&1486220894071";
	console.log(getUrl);
	
	$.ajax({
		statusCode: {
			500: function() {
				console.error("Error while placing order.");
			}
		},
		url : getUrl,
		type: "GET",
		async: false,
		success: function(data, textStatus, jqXHR)
		{		
			if(data != null && data.status == "success"){
				result = getOpenHighLow(data);
			}
		},
		error: function (jqXHR, textStatus, errorThrown)
		{
			console.log("error");
		}
	});
	return result;
}

function getOrderStatus(orderIds)
{ 
    $.ajaxSettings.beforeSend=function(xhr){
        xhr.setRequestHeader('Accept', "application/json, text/plain, */*");
        xhr.setRequestHeader('Content-Type', "application/json;charset=utf-8");
		xhr.setRequestHeader('x-csrftoken', csrfToken);
    };
	var result="";
	var getUrl="https://kite.zerodha.com/api/orders/"+orderIds.OrderId+"/";
	
	$.ajax({
		statusCode: {
			500: function() {
				console.error("Error while placing order.");
			}
		},
		url : getUrl,
		type: "GET",
		async: false,
		success: function(data, textStatus, jqXHR)
		{		
			if(data != null && data.status == "success"){
				if(data.data[0].status == "COMPLETE"){
					if(orderIds.Status==""){
						orderIds.Status = "COMPLETE";
					}
					console.log(status);
				}
				else if(data.data[0].status == "REJECTED" && orderIds.Status == ""){
					orderIds.Status = "REJECTED";
				}
			}
		},
		error: function (jqXHR, textStatus, errorThrown)
		{
			console.log("error");
		}
	});
	return status;
}
start();
